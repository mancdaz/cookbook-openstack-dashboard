# encoding: UTF-8
require_relative 'spec_helper'

describe 'openstack-dashboard::server' do

  describe 'opensuse' do

    let(:runner) { ChefSpec::Runner.new(OPENSUSE_OPTS) }
    let(:node) { runner.node }
    let(:chef_run) do
      runner.converge(described_recipe)
    end

    include_context 'non_redhat_stubs'
    include_context 'dashboard_stubs'

    context 'mysql backend' do

      include_context 'mysql_backend'

      it 'installs mysql packages when mysql backend is configured' do
        expect(chef_run).to upgrade_package 'python-mysql'
      end
    end

    context 'postgresql backend' do

      include_context 'postgresql_backend'
      let(:file) { chef_run.template('/usr/share/openstack-dashboard/openstack_dashboard/local/local_settings.py') }

      it 'installs packages' do
        expect(chef_run).to upgrade_package 'openstack-dashboard'
      end

      it 'installs postgresql packages' do
        expect(chef_run).to upgrade_package 'python-psycopg2'
      end

      it 'creates local_settings.py' do
        expect(chef_run).to render_file(file.name).with_content('autogenerated')
      end

      it 'creates .blackhole dir with proper owner' do
        dir = '/usr/share/openstack-dashboard/openstack_dashboard/.blackhole'
        expect(chef_run.directory(dir).owner).to eq('root')
      end
    end
  end
end
